<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Adding meta -->

        <!-- Adding external script-->

        <!-- Adding external style-->

        <!-- Adding scripts-->

        <!-- Adding style-->

        <!-- Adding overlay script-->

        <!-- Adding overlay style-->

        <title>index.js</title>

        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css" />
        <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css" />
        <link type="text/css" rel="stylesheet" href="styles/reset.css" />
        <link type="text/css" rel="stylesheet" href="styles/heading.css" />
        <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css" />
        <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-light.css" />

        <svg
            aria-hidden="true"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            style="display: none"
        >
            <defs>
                <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
                    <g>
                        <path
                            d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"
                        />
                        <path
                            d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"
                        />
                    </g>
                </symbol>
                <symbol id="search-icon" viewBox="0 0 512 512">
                    <g>
                        <g>
                            <path
                                d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"
                            />
                        </g>
                    </g>
                    <g>
                        <g>
                            <path
                                d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"
                            />
                        </g>
                    </g>
                </symbol>
                <symbol id="down-icon" viewBox="0 0 16 16">
                    <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
                    ></path>
                </symbol>
            </defs>
        </svg>
    </head>

    <body>
        <nav class="navbar" id="navbar">
            <div class="navbar-heading" id="navbar-heading">
                <a href="index.html"><h2 class="navbar-heading-text">Home</h2></a>
            </div>
            <div class="search-box" id="search-box">
                <div class="search-box-input-container">
                    <input
                        class="search-box-input"
                        type="text"
                        placeholder="Search..."
                        id="search-box-input"
                    /><svg class="search-icon" alt="search-icon">
                        <use xlink:href="#search-icon"></use>
                    </svg>
                </div>
                <div class="search-item-container" id="search-item-container">
                    <ul class="search-item-ul" id="search-item-ul"></ul>
                </div>
            </div>
            <div class="sidebar-main-content" id="sidebar-main-content">
                <div class="accordion collapsed" id="7679992">
                    <h3 class="accordion-heading">
                        Classes<svg><use xlink:href="#down-icon"></use></svg>
                    </h3>
                    <ul class="accordion-content">
                        <li class="accordion collapsed child" id="3047382">
                            <div class="accordion-heading child">
                                <a href="WsClient.html">WsClient</a
                                ><svg><use xlink:href="#down-icon"></use></svg>
                            </div>
                            <ul class="methods accordion-content">
                                <li data-type="method">
                                    <a href="WsClient.html#connect">connect</a>
                                </li>
                                <li data-type="method">
                                    <a href="WsClient.html#getTotMessages">getTotMessages</a>
                                </li>
                                <li data-type="method">
                                    <a href="WsClient.html#onConnectionFailure"
                                        >onConnectionFailure</a
                                    >
                                </li>
                                <li data-type="method">
                                    <a href="WsClient.html#onConnectionReestablished"
                                        >onConnectionReestablished</a
                                    >
                                </li>
                                <li data-type="method">
                                    <a href="WsClient.html#onMessage">onMessage</a>
                                </li>
                                <li data-type="method"><a href="WsClient.html#send">send</a></li>
                                <li data-type="method">
                                    <a href="WsClient.html#setAuthenticationToken"
                                        >setAuthenticationToken</a
                                    >
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="accordion collapsed" id="6175723">
                    <h3 class="accordion-heading">
                        Modules<svg><use xlink:href="#down-icon"></use></svg>
                    </h3>
                    <ul class="accordion-content">
                        <li class="accordion collapsed child" id="1096515">
                            <div class="accordion-heading child">
                                <a href="module-Server.html">Server</a
                                ><svg><use xlink:href="#down-icon"></use></svg>
                            </div>
                            <ul class="methods accordion-content">
                                <li data-type="method">
                                    <a href="module-Server.html#~addToGroup">addToGroup</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~addUser">addUser</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~checkAuthentication"
                                        >checkAuthentication</a
                                    >
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~deleteGroup">deleteGroup</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~deleteUser">deleteUser</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~init">init</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~onClientClosed">onClientClosed</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~onConnection">onConnection</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~onMessage">onMessage</a>
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~sendMessageToGroup"
                                        >sendMessageToGroup</a
                                    >
                                </li>
                                <li data-type="method">
                                    <a href="module-Server.html#~sendMessageToUser"
                                        >sendMessageToUser</a
                                    >
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="accordion collapsed" id="7164937">
                    <h3 class="accordion-heading">
                        Global<svg><use xlink:href="#down-icon"></use></svg>
                    </h3>
                    <ul class="accordion-content">
                        <li class="accordion-list" id="">
                            <a href="global.html#checkAuthenticationCallback"
                                >checkAuthenticationCallback</a
                            >
                        </li>
                        <li class="accordion-list" id="">
                            <a href="global.html#onClientClosedCallback">onClientClosedCallback</a>
                        </li>
                        <li class="accordion-list" id="">
                            <a href="global.html#onConnectionCallback">onConnectionCallback</a>
                        </li>
                        <li class="accordion-list" id="">
                            <a href="global.html#onMessageCallbackClient"
                                >onMessageCallbackClient</a
                            >
                        </li>
                        <li class="accordion-list" id="">
                            <a href="global.html#onMessageCallbackServer"
                                >onMessageCallbackServer</a
                            >
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="navbar-ham" id="navbar-ham">
            <div>
                <div class="first"></div>
                <div class="second"></div>
                <div class="third"></div>
            </div>
        </div>

        <div id="main" class="main-content">
            <h1 id="page-title" class="page-title">index.js</h1>

            <section>
                <article>
                    <pre class="prettyprint source linenums"><code>/**
 * @module Server
 */

const exposedMethods = require("./exposedMethods");
const ws = require("ws");
const utils = require("./utils");
const handling = require("./handling");
const Redis = require("ioredis");
let redisPublisher, redisSubscriber, websocket, pingPongInterval;

function setup() {
    websocket.on("connection", function connection(ws) {
        ws.isAlive = true;
        ws.on("message", async function incoming(message) {
            if (message === "pong") {
                ws.isAlive = true;
                ws.send("ack");
            }
            if (!utils.isJson(message)) return;
            message = JSON.parse(message);
            if (utils.isInitial(message)) {
                let checkAuthenticationCallback = handling.config.checkAuthenticationCallback;

                if (message.token &amp;&amp; checkAuthenticationCallback) {
                    const isAuthenticated = await checkAuthenticationCallback(message.token);
                    if (!isAuthenticated) return;
                }
                handling.config.onConnectionCallback(ws, message.token);
            } else {
                handling.handleMessage(message, ws);
            }
        });
        ws.on("close", () => {
            handling.deleteUserByConnection(ws);
        });
        ws.on("error", (e) => {
            console.log(e);
        });
    });
}

/**
 * Send message to a specific user
 * @param {string} identifier - Username / user identifier
 * @param {string} channel - Channel name (client will receive a message on this channel)
 * @param {*} data - Data to send
 */
function sendMessageToUser(identifier, channel, data) {
    if (identifier in handling.users) {
        handling.users[identifier].send(JSON.stringify({ data, channel }));
    } else {
        redisPublisher.publish(
            "ws-redis",
            JSON.stringify({ identifier, channel, data, isGroup: false })
        );
    }
}

/**
 * Send message to all users in the given group
 * @param {string} identifier - Group name
 * @param {string} channel - Channel name (clients will receive a message on this channel)
 * @param {*} data - Data to send
 * @param {boolean=} pubOnRedis - Whether to publish on redis to ensure delivery to all clients
 */
function sendMessageToGroup(identifier, channel, data, pubOnRedis = true) {
    if (identifier in handling.groups) {
        handling.groups[identifier].forEach((user) => {
            user.send(JSON.stringify({ data, channel }));
        });
    }
    if (pubOnRedis) {
        redisPublisher.publish(
            "ws-redis",
            JSON.stringify({ identifier, channel, data, isGroup: true, pid: process.pid })
        );
    }
}

/**
 * Initiate ws-redis
 * @param {WebSocket} wsInstance - WebSocket server instance
 * @return {Promise} Promise object rapresents the redis status
 */
async function init(wsInstance) {
    return new Promise((resolve, reject) => {
        if (!(wsInstance instanceof ws || wsInstance instanceof ws.Server)) {
            return reject("wsInstance must be a WebSocket instance");
        }
        websocket = wsInstance;
        setup();
        if (!redisPublisher) redisPublisher = new Redis();
        if (!redisSubscriber) {
            redisSubscriber = new Redis();

            redisSubscriber.on("message", (c, message) => {
                //TODO: check if the message is valid
                const { identifier, channel, data, isGroup, pid } = JSON.parse(message);
                if (pid == process.pid) return;
                if (isGroup &amp;&amp; identifier in handling.groups) {
                    sendMessageToGroup(identifier, channel, data, false);
                } else if (identifier in handling.users) {
                    sendMessageToUser(identifier, channel, data);
                }
            });
            redisSubscriber.subscribe("ws-redis", (err) => {
                if (err) reject(err);
                else resolve();
            });
        } else {
            resolve();
        }

        pingPongInterval = setInterval(() => {
            handling.pingPong(websocket);
        }, 2000);
    });
}

module.exports = {
    ...exposedMethods,
    init,
    close: async () => {
        await websocket.close();
        clearInterval(pingPongInterval);
    },
    clean: () => {
        handling.clean();
    },
    sendMessageToUser,
    sendMessageToGroup,
};
</code></pre>
                </article>
            </section>
        </div>

        <footer class="footer" id="footer"></footer>

        <script src="scripts/third-party/prettify.js"></script>
        <script src="scripts/third-party/lang-css.js"></script>
        <script type="text/javascript" src="scripts/misc.js"></script>

        <script>
            prettyPrint();
        </script>
        <script src="scripts/linenumber.js"></script>
        <script src="scripts/fix-code-block.js"></script>
        <script src="scripts/fix-navbar.js"></script>

        <script src="scripts/search.js"></script>
        <script src="scripts/third-party/fuse.js"></script>
        <script>
            var list = [
                { title: "WsClient", link: '<a href="WsClient.html">WsClient</a>' },
                {
                    title: "WsClient#connect",
                    link: '<a href="WsClient.html#connect">WsClient &rtrif; connect</a>',
                },
                {
                    title: "WsClient#getTotMessages",
                    link: '<a href="WsClient.html#getTotMessages">WsClient &rtrif; getTotMessages</a>',
                },
                {
                    title: "WsClient#onConnectionFailure",
                    link: '<a href="WsClient.html#onConnectionFailure">WsClient &rtrif; onConnectionFailure</a>',
                },
                {
                    title: "WsClient#onConnectionReestablished",
                    link: '<a href="WsClient.html#onConnectionReestablished">WsClient &rtrif; onConnectionReestablished</a>',
                },
                {
                    title: "WsClient#onMessage",
                    link: '<a href="WsClient.html#onMessage">WsClient &rtrif; onMessage</a>',
                },
                {
                    title: "WsClient#send",
                    link: '<a href="WsClient.html#send">WsClient &rtrif; send</a>',
                },
                {
                    title: "WsClient#setAuthenticationToken",
                    link: '<a href="WsClient.html#setAuthenticationToken">WsClient &rtrif; setAuthenticationToken</a>',
                },
                { title: "Server", link: '<a href="module-Server.html">Server</a>' },
                {
                    title: "module:Server~addToGroup",
                    link: '<a href="module-Server.html#~addToGroup">module:Server~addToGroup &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~addUser",
                    link: '<a href="module-Server.html#~addUser">module:Server~addUser &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~checkAuthentication",
                    link: '<a href="module-Server.html#~checkAuthentication">module:Server~checkAuthentication &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~deleteGroup",
                    link: '<a href="module-Server.html#~deleteGroup">module:Server~deleteGroup &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~deleteUser",
                    link: '<a href="module-Server.html#~deleteUser">module:Server~deleteUser &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~init",
                    link: '<a href="module-Server.html#~init">module:Server~init &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~onClientClosed",
                    link: '<a href="module-Server.html#~onClientClosed">module:Server~onClientClosed &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~onConnection",
                    link: '<a href="module-Server.html#~onConnection">module:Server~onConnection &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~onMessage",
                    link: '<a href="module-Server.html#~onMessage">module:Server~onMessage &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~sendMessageToGroup",
                    link: '<a href="module-Server.html#~sendMessageToGroup">module:Server~sendMessageToGroup &rtrif; undefined</a>',
                },
                {
                    title: "module:Server~sendMessageToUser",
                    link: '<a href="module-Server.html#~sendMessageToUser">module:Server~sendMessageToUser &rtrif; undefined</a>',
                },
                {
                    title: "checkAuthenticationCallback",
                    link: '<a href="global.html#checkAuthenticationCallback">checkAuthenticationCallback</a>',
                },
                {
                    title: "onClientClosedCallback",
                    link: '<a href="global.html#onClientClosedCallback">onClientClosedCallback</a>',
                },
                {
                    title: "onConnectionCallback",
                    link: '<a href="global.html#onConnectionCallback">onConnectionCallback</a>',
                },
                {
                    title: "onMessageCallbackClient",
                    link: '<a href="global.html#onMessageCallbackClient">onMessageCallbackClient</a>',
                },
                {
                    title: "onMessageCallbackServer",
                    link: '<a href="global.html#onMessageCallbackServer">onMessageCallbackServer</a>',
                },
            ];
            var options = setupSearch(list, options);
        </script>
    </body>
</html>
